<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting - KairAlert</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-main: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-teal: #2dd4bf;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .container {
            text-align: center;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .logo-img {
            width: 100%;
            height: auto;
            border-radius: 20px;
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-teal);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .message {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .manual-link {
            margin-top: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            display: none;
            /* Hidden by default */
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">
            <img class="logo-img" src="https://kairalert.pro/assets/kairalert-logo.jpg" alt="KairAlert">
        </div>
        <div class="loader"></div>
        <div class="message" id="message">Opening Broker...</div>
        <a id="manualLink" class="manual-link" href="#">Click here if not redirected</a>
    </div>

    <script>
        // Extracted Broker Configuration from universal_app.html
        const BROKERS = [
            {
                id: 'tradingview',
                name: 'TradingView',
                url: {
                    web: ['https://www.tradingview.com/symbols/${exchange}-${ticker}/']
                }
            },
            {
                id: 'ibkr',
                name: 'IBKR',
                url: {
                    web: ['https://www.interactivebrokers.com/portal/#/quote/${ibkr_conid}']
                }
            },
            {
                id: 'webull',
                name: 'WeBull',
                url: {
                    web: ['https://www.webullapp.com/ticker/${exchange}-${ticker}']
                }
            },
            {
                id: 'futu',
                name: 'Futu',
                url: {
                    web: ['https://www.futunn.com/stock/${ticker}-US'],
                    app: ['ftnn://quote/stockDetail/${futu_id}/1', 'futunn://trade/US/${ticker}/10/0']
                }
            },
            {
                id: 'tiger',
                name: 'Tiger',
                url: {
                    web: ['https://www.itiger.com/stock/${ticker}'],
                    app: ['tigerbrokersusstock://com.tigerbrokers.usstock/main/J/stock?symbol=${ticker}&market=US&secType=STK', 'tigerbrokersusstock://com.tigerbrokers.usstock/main/J/place_order?symbol=${ticker}&market=US&secType=STK&action=BUY']
                }
            },
            {
                id: 'longbridge',
                name: 'Longbridge',
                url: {
                    app: ['lb://page/stock/detail?id=ST/US/${ticker}', 'lb://page/trade/order?counter_id=ST/US/${ticker}']
                }
            },
            {
                id: 'firsttrade',
                name: 'FirstTrade',
                url: {
                    web: ['https://invest.firstrade.com/app/stocks-etf/${ticker}/overview']
                }
            }
        ];

        function getParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                ticker: params.get('ticker') || '',
                futu_id: params.get('futu_id') || '',
                ibkr_conid: params.get('ibkr_conid') || '',
                exchange: params.get('exchange') || '',
                broker_id: localStorage.getItem('broker_id') || 'ibkr',
            };
        }

        function resolveUrl(template, params) {
            let url = template;
            // url = url.replace(/\${ticker}/g, params.ticker);
            // url = url.replace(/\${futu_id}/g, params.futu_id);
            // url = url.replace(/\${ibkr_conid}/g, params.ibkr_conid);
            // url = url.replace(/\${exchange}/g, params.exchange);
            for (let key in params) {
                url = url.replace(new RegExp(`\\$\\{${key}\\}`, 'g'), params[key]);
            }
            return url;
        }

        function init() {
            const params = getParams();
            const messageEl = document.getElementById('message');
            const manualLink = document.getElementById('manualLink');

            if (!params.broker_id) {
                messageEl.textContent = "Error: Missing broker_id";
                return;
            }

            const broker = BROKERS.find(b => b.id === params.broker_id);
            if (!broker) {
                messageEl.textContent = "Error: Invalid Broker ID";
                return;
            }

            messageEl.textContent = `Opening ${broker.name}...`;

            // Determine URL templates
            let templates = [];
            let isAppLink = false;

            if (broker.url.app) {
                templates = broker.url.app;
                isAppLink = true;
            } else if (broker.url.web) {
                templates = broker.url.web;
                isAppLink = false;
            } else {
                messageEl.textContent = `Error: No ${type} link for ${broker.name}`;
                return;
            }

            // For now, take the first URL in the array. 
            // NOTE: The extracted logic from universal_app.html implies index 0 is Quote/Analysis, index 1 is Trade.
            // The user request didn't specify distinct 'action' (quote vs trade) param for this page, 
            // but the 'type' param is likely just platform type. 
            // However, looking at the universal_app.html implementation:
            // btnAnalysis uses index 0 (or specific hardcoded link logic)
            // btnTrade uses index 1 (or specific hardcoded link logic)

            // To be safe, let's assume index 0 by default. 
            // If the user starts asking for trade links, we might need an 'action' parameter.
            // For now I will stick to the first link (Quote/Analysis) as default.

            const urlTemplate = templates[0];
            const finalUrl = resolveUrl(urlTemplate, params);

            // Manual link fallback
            manualLink.href = finalUrl;
            manualLink.style.display = 'block';

            // Attempt Redirect
            // Use location.replace for history handling, or href
            setTimeout(() => {
                window.location.replace(finalUrl);

                if (isAppLink) {
                    setTimeout(() => {
                        window.close();
                        history.back();
                    }, 1000);
                }
            }, 0);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>