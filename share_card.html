<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market Insight</title>
  <style>
    :root {
      --bg-color: #0a0a0a;
      --card-bg: rgba(20, 20, 25, 0.3);
      --card-border: rgba(255, 255, 255, 0.1);
      --text-main: #ffffff;
      --text-secondary: #a0a0a0;
      /* Chinese/Asian Market Style: Red = Up, Green = Down */
      --market-up: #fb7185;
      /* Soft Red/Pink */
      --market-down: #10b981;
      /* Emerald Green */
      --accent-teal: #2dd4bf;
      --accent-red-bg: rgba(225, 29, 72, 0.15);

      /* UI Features */
      --risk-bg: rgba(245, 158, 11, 0.15);
      /* Yellow/Amber */
      --risk-text: #f59e0b;
      --risk-border: rgba(245, 158, 11, 0.3);

      --disclaimer-bg: rgba(225, 29, 72, 0.15);
      /* Red/Alert */
      --disclaimer-text: #fb7185;
      --disclaimer-border: rgba(225, 29, 72, 0.3);

      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --glow-color: rgba(45, 212, 191, 0.25);
    }

    * {
      box-sizing: border-box;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-family);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      box-sizing: border-box;
      background-image: radial-gradient(circle at 50% 0%, var(--glow-color) 0%, transparent 60%);
      background-attachment: fixed;
    }

    .container {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Glassmorphism Card */
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .ticker-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ticker-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ticker {
      max-width: 150px;
      font-size: 32px;
      font-weight: 800;
      margin-top: 3px;
      letter-spacing: -0.5px;
      line-height: 1.1;
      cursor: pointer;
      position: relative;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .ticker:active {
      opacity: 0.7;
    }

    .copy-icon {
      width: 16px;
      height: 16px;
      opacity: 0.5;
      transition: opacity 0.2s;
      margin-top: 10px;
    }

    .ticker:hover .copy-icon {
      opacity: 1;
    }

    .ticker-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: contain;
      background: #fff;
      /* Ensure transparency looks okay */
      display: none;
      /* Hidden by default until loaded */
    }

    .ticker-logo.loaded {
      display: block;
    }

    .header-tips {
      margin-top: -24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 40px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(30, 30, 35, 0.9);
      color: #fff;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .price-group {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .price {
      font-size: 24px;
      font-weight: 600;
      text-align: right;
      letter-spacing: -0.5px;
      color: var(--text-main);
    }

    .price-change {
      font-size: 13px;
      font-weight: 600;
    }

    .text-up {
      color: var(--market-up);
    }

    .text-down {
      color: var(--market-down);
    }

    .price-label {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.6;
      margin-top: 2px;
      text-align: right;
      font-weight: 400;
    }

    .header-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 16px;
    }

    .metric-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-label {
      font-size: 12px;
      /* text-transform: uppercase; */
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      font-weight: 600;
    }

    .metric-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
    }

    /* News Section */
    .news-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .news-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .news-tag {
      font-size: 12px;
      /* text-transform: uppercase; */
      letter-spacing: 0.5px;
      font-weight: 700;
      padding: 3px 6px;
      border-radius: 4px;
      line-height: 1;
    }

    .section-label {
      font-size: 11px;
      /* text-transform: uppercase; */
      letter-spacing: 1px;
      color: var(--text-secondary);
      opacity: 0.8;
      font-weight: 700;
    }

    .news-timestamp {
      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.8;
      font-weight: 500;
    }

    .news-title {
      font-size: 16px;
      font-weight: 700;
      line-height: 1.4;
      color: var(--accent-teal);
      margin: 0;
    }

    .news-analysis {
      font-size: 15px;
      line-height: 1.6;
      opacity: 0.9;
      margin: 0;
      color: #d4d4d4;
    }

    /* Yellow Risk Box */
    .risk-box {
      background: var(--risk-bg);
      border: 1px solid var(--risk-border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .risk-title {
      color: var(--risk-text);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .risk-content {
      font-size: 13px;
      color: #e5e5e5;
      line-height: 1.4;
    }

    /* Red Disclaimer Box */
    .disclaimer-box {
      background: var(--disclaimer-bg);
      border: 1px solid var(--disclaimer-border);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .disclaimer-title {
      color: var(--disclaimer-text);
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .disclaimer-text {
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: transform 0.2s, opacity 0.2s;
      position: relative;
      overflow: hidden;
      margin: 0;
    }

    /* Action Buttons */
    .actions-grid {
      display: flex;
      /* Changed from grid to flex */
      gap: 12px;
      margin-top: 16px;
      margin-bottom: 8px;
      /* Spacing before disclaimer */
      width: 100%;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
      flex: 1;
      /* Default to flexible width */
    }

    .action-btn.fixed-width {
      flex: 0 0 40px;
      /* Fixed width for Settings */
      width: 40px;
    }

    .action-btn:active {
      transform: scale(0.96);
    }

    .btn-glass {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      color: #fff;
    }

    /* Softer Teal Style */
    .btn-primary {
      background: rgba(45, 212, 191, 0.15);
      /* Tinted glass */
      border: 1px solid rgba(45, 212, 191, 0.3);
      color: var(--accent-teal);
      box-shadow: 0 4px 12px rgba(20, 184, 166, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .btn-primary:hover {
      background: rgba(45, 212, 191, 0.25);
      border-color: rgba(45, 212, 191, 0.5);
      box-shadow: 0 6px 16px rgba(20, 184, 166, 0.2);
      transform: translateY(-1px);
    }

    .btn-primary:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: contain;
      display: block;
    }

    /* Adjust icon margin for icon-only buttons */
    .action-btn.fixed-width .btn-icon {
      margin-right: 0;
      width: 20px;
      height: 20px;
      opacity: 0.8;
      filter: grayscale(100%) brightness(200%);
      /* Make it look like a white icon */
    }

    .external-link-icon {
      width: 12px;
      height: 12px;
      margin-left: 4px;
      opacity: 0.6;
      flex-shrink: 0;
    }

    /* Brand */
    .brand-section {
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Brand Logo */
    .brand-logo {
      max-width: 60px;
    }

    /* Brand Name */
    .brand-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-decoration: underline;
    }

    /* Footer */
    .footer {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;

      font-size: 11px;
      color: var(--text-secondary);
      opacity: 0.5;
      font-family: monospace;
    }

    .state-message {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .hidden {
      display: none !important;
    }

    /* Settings Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      /* Limit height */
      background: rgba(30, 30, 35, 0.85);
      /* Darker glass */
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow: hidden;
    }

    .modal-overlay.show .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }

    .modal-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .broker-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      /* Enable scrolling */
      overscroll-behavior: contain;
      /* Prevent body scroll */
      padding-right: 4px;
      /* Space for scrollbar */
      flex: 1;
      min-height: 0;
    }

    .broker-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .broker-item:hover {
      background: rgba(255, 255, 255, 0.06);
    }

    .broker-item.selected {
      background: rgba(45, 212, 191, 0.15);
      border-color: var(--accent-teal);
      box-shadow: 0 0 12px rgba(45, 212, 191, 0.1);
    }

    .broker-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .broker-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      background: #000;
    }

    .broker-name {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
    }

    .broker-meta {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .platform-icon {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 10px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .platform-icon svg {
      width: 10px;
      height: 10px;
      opacity: 0.7;
    }

    .check-icon {
      color: var(--accent-teal);
      opacity: 0;
      /* transform: scale(0.5); */
      /* transition: all 0.2s; */
      width: 20px;
      height: 20px;
    }

    .broker-item.selected .check-icon {
      opacity: 1;
      /* transform: scale(1); */
    }

    /* Chart Styles */
    .chart-wrapper {
      width: 100%;
      aspect-ratio: 21 / 9;
      position: relative;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid var(--card-border);
      overflow: hidden;
      margin-top: 8px;
    }

    canvas#stockChart {
      display: block;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>

  <div class="container">
    <div id="mainCard" class="card hidden">
      <!-- Header -->
      <div class="header">
        <div class="ticker-group">
          <div class="ticker-row">
            <img id="tickerLogo" class="ticker-logo" alt="" />
            <div id="ticker" class="ticker" onclick="copyTicker()">
              <span id="tickerText">--</span>
              <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </div>
          </div>
          <!-- <span class="header-label">Stock Ticker</span> -->
        </div>
        <div class="price-group">
          <span class="price" id="price">--</span>
          <span class="price-change" id="priceChange">--</span>
          <!-- <span class="price-label">--</span> -->
        </div>
      </div>

      <div class="header-tips">
        <span class="header-label">Stock Ticker</span>
        <span class="price-label">Price at push, not real-time</span>
      </div>

      <!-- Metrics -->
      <div class="metrics-grid">
        <div class="metric-item">
          <span class="metric-label">Market Cap</span>
          <span id="marketCap" class="metric-value">--</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Volume</span>
          <span id="volume" class="metric-value">--</span>
        </div>
      </div>

      <!-- News & Analysis -->
      <div class="news-section">
        <div class="news-header">
          <span id="newsTag" class="section-label">Latest Insight</span>
          <span class="section-label">•</span>
          <span id="newsTimestamp" class="news-timestamp">--</span>
        </div>
        <h2 id="newsTitle" class="news-title">--</h2>
        <p id="analysis" class="news-analysis">--</p>

        <!-- Stock Chart -->
        <div class="chart-wrapper">
          <canvas id="stockChart"></canvas>
        </div>

        <!-- Yellow Risk Box -->
        <div class="risk-box">
          <div class="risk-title">Risk Factor</div>
          <div id="risk" class="risk-content">--</div>
        </div>

        <!-- Brand -->
        <div class="brand-section">
          <a class="brand-label" href="https://kairalert.pro/" target="_blank">从提醒由 KairAlert 发送</a>
          <img class="brand-logo" src="https://kairalert.pro/assets/logo.png" />
        </div>

        <!-- Action Buttons (Analysis | Trade | Settings) -->
        <div class="actions-grid">
          <!-- Analysis (Flex 1) -->
          <a href="#" id="js-btn-detail" class="action-btn btn-glass">
            <img src="https://www.futunn.com/favicon.ico" class="btn-icon" alt="Futu">
            <span class="btn-text">Analysis</span>
            <svg class="external-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
          <!-- Trade (Flex 1) -->
          <a href="#" id="js-btn-trade" class="action-btn btn-primary">
            <img src="https://www.futunn.com/favicon.ico" class="btn-icon" alt="Futu">
            <span class="btn-text">Trade</span>
            <svg class="external-link-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </a>
          <!-- Settings (Fixed) -->
          <div id="btnSettings" class="action-btn btn-glass fixed-width" onclick="openSettingsModal()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
              </path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Red Disclaimer Box -->
      <div class="disclaimer-box">
        <div class="disclaimer-title">Disclaimer</div>
        <p class="disclaimer-text">For reference only. NOT investment advice.</p>
      </div>
      <!-- (Removed old actions-grid from here) -->
    </div>

    <div id="loading" class="state-message">Loading data...</div>
    <div id="error" class="state-message hidden" style="color: var(--market-up);"></div>

    <div id="toast" class="toast">Copied to clipboard</div>

    <div class="footer">
      <span id="version">--</span> | <span id="uid">--</span>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <span class="modal-title">Select Broker</span>
          <button class="modal-close" onclick="closeSettingsModal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div id="brokerList" class="broker-list">
          <!-- Broker Items will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const VERSION = "20260109-002";

    const $ = id => document.getElementById(id);

    const TAG_MAP_ZH = {
      "C1": "收购/合并",
      "C2": "资产出售",
      "C3": "临床/药物",
      "C4": "战略融资",
      "C5": "战略合作",
      "C6": "重大合同"
    };
    const TAG_MAP_EN = {
      "C1": "Acquisition/Merger",
      "C2": "Asset Sale",
      "C3": "Clinical/Drug",
      "C4": "Financing",
      "C5": "Cooperation",
      "C6": "Major Contract"
    };
    const TAG_COLOR_MAP = {
      "C1": 0x48f4b2,
      "C2": 0x39a5ec,
      "C3": 0xb56ad4,
      "C4": 0xe67e22,
      "C5": 0xe74c3c,
      "C6": 0xd6b35b
    };

    function generateUid() {
      // 9 digitals
      return Math.random().toString().slice(2, 11);
    }

    function initUid() {
      const uid = localStorage.getItem('uid');
      if (uid) {
        // If UID exists, use it
        console.log("Using existing UID:", uid);
      } else {
        // If not, create a new UID
        const newUid = generateUid();
        localStorage.setItem('uid', newUid);
        console.log("Generated new UID:", newUid);
      }
    }

    function hexToRgba(hex, alpha) {
      const r = (hex >> 16) & 255;
      const g = (hex >> 8) & 255;
      const b = hex & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function numberToHexStr(hex) {
      return "#" + hex.toString(16).padStart(6, '0');
    }

    const translations = {
      en: {
        marketCap: "Market Cap",
        volume: "Volume",
        latestInsight: "Latest Insight",
        riskFactor: "Risk Factor",
        disclaimerTitle: "Disclaimer",
        disclaimerText: "For reference only. NOT investment advice.",
        copied: "Copied to clipboard",
        stockTicker: "Stock Ticker",
        priceLabel: "Price at push, not real-time",
        btnDetail: "Quote",
        btnTrade: "Trade",
        sendByKairAlert: "This alert was sent by KairAlert."
      },
      zh: {
        marketCap: "市值",
        volume: "成交量",
        latestInsight: "最新观点",
        riskFactor: "风险提示",
        disclaimerTitle: "免责声明",
        disclaimerText: "推送信息仅供参考，不构成投资建议",
        copied: "已复制到剪贴板",
        stockTicker: "股票代码",
        priceLabel: "推送时价格，非实时更新",
        btnDetail: "股票行情",
        btnTrade: "立即交易",
        sendByKairAlert: "此提醒由 KairAlert 发送."
      }
    };

    let currentLang = 'en';


    // HARDCODED STATIC DATA
    window.queryData = {
      ticker: "TSLA",
      market_cap: "780.5B",
      volume: "35M",
      price: "245.80",
      title: "Tesla Surpasses Deliveries Expectations",
      analysis: "Strong Q4 production results drive bullish sentiment. Analysts upgrade price targets.",
      risk: "High Volatility",
      change: "+4.2%",
      timestamp: "1768469425252", // Fixed timestamp
      logoid: "tsla",
      futu_id: "1123",
      category_code: "C5",
      exchange: "NASDAQ",
      ibkr_conid: "789",
      compressed_chart: "149.91|10,-13,19,13,-9,-19,14,9,-7,-12,18,-18,-6,9,3,-9,17,15,3,8,4,-2,-16,-7,5,9,-14,-17,-5,8,-8,-17,-11,-13,16,-13,17,-4,-19,-3,-19,-18,8,15,12,-16,16,-10,0,2,5,0,19,-10,-8,-17,14,-2,17,-20,-18,-16,-18,10,-19,-10,5,-13,10,11,-9,15,12,-4,-19,-19,-6,2,4,14,5,-16,-20,17,9,15,-10,12,17,6,20,-16,-14,-14,-3,3,-19,-7,5,_15,14,-11,13,3,3,-19,16,12,-6,12,-15,-7,-11,-6,-2,17,-2,20,-17,-16,9,-10,1,6,-7,18,-9,18,-8,-6,-19,8,-20,-19,-18,-4,-11,-7,2,-16,-3,16,-15,-18,19,2,-9,4,-5,12,15,6,12,3,9,-18,-11,-4,-9,2,-18,1,-12,-9,19,4,10,10,-4,1,12,-12,12,19,2,-6,10,-5,13,16,2,16,-3,-2,9,-3,1,-6,-1,-8,-6,17,-5,18,-20,11,-17,4,-11,-12,18,-17,10,-19,19,-16,18,15,0,-6,-13,5,4,19,11,-11,-8,-5,-15,-19,-20,-11,-12,-13,-16,-17,-6,8,-8,10,-8,18,16,-9,1,_10,-1,-5,2,-12,10,13,-5,15,3,-12,8,10,3,11,-11,-8,-12,-6,-10,7,4,13,12,-14,-2,14,-14,15,-16,17,-5,13,12,-15,5,-10,13,-8,18,-15,-15,16,-8,14,1,-18,-11,3,-8,4,-4,10,9,-10,-10,2,2,-20,-10,13,1,-13,17,3,10,11,-17,4,1,-13,15,9,-17,10,-15,-18,-1,19,7,-16,5,8,-19,-13,14,9,8,-3,-13,-12,17,15,-16,16,19,-4,-1,-13,-13,8,8,7,14,11,17,-7,-13,15,-4,6,8,-10,15,-16,4,-9,10,8,16,0,-9,-4,-2,11,6,-12,1,-17,11,13"
    };

    let queryData = window.queryData;
    const params = new URLSearchParams(window.location.search);

    function decodeData() {
      return window.queryData;
    }

    function replaceUrl(url, data) {
      for (const key in data) {
        url = url.replace(new RegExp(`\\$\\{${key}\\}`, 'g'), encodeURIComponent(data[key]));
      }
      return url;
    }

    function updateBrokerButtons(data) {
      const brokerId = localStorage.getItem('broker_id') || BROKERS[0].id;
      const brokerInfo = BROKERS.find(broker => broker.id === brokerId);
      const urls = brokerInfo.url.app || brokerInfo.url.web || [];

      const $detailBtn = $('js-btn-detail');
      const $tradeBtn = $('js-btn-trade');

      let [detailUrl, tradeUrl] = urls;

      if (detailUrl) {
        detailUrl = replaceUrl(detailUrl, data);
        $detailBtn.href = detailUrl;
        $detailBtn.querySelector('img').src = brokerInfo.logo;
        $detailBtn.style.display = 'flex';
      } else {
        $detailBtn.style.display = 'none'; // Basic fallback
      }

      if (tradeUrl) {
        tradeUrl = replaceUrl(tradeUrl, data);
        $tradeBtn.href = tradeUrl;
        $tradeBtn.querySelector('img').src = brokerInfo.logo;
        $tradeBtn.style.display = 'flex';
      } else {
        $tradeBtn.style.display = 'none'; // Basic fallback
      }

      let redirect = params.get('r');

      if (redirect) {
        if (redirect === 'd' && detailUrl) {
          window.location.href = detailUrl;
        } else if (redirect === 't' && tradeUrl) {
          window.location.href = tradeUrl;
        }
      }
    }

    function render() {
      const data = decodeData();
      const loadingEl = $('loading');
      const cardEl = $('mainCard');
      const uid = localStorage.getItem('uid');

      queryData = data || {};

      if (!data) {
        loadingEl.classList.add('hidden');
        $('error').textContent = "Unable to load market data.";
        $('error').classList.remove('hidden');
        return;
      }

      // Apply Translations
      const t = translations[currentLang];
      document.querySelector('.metric-item:nth-child(1) .metric-label').textContent = t.marketCap;
      document.querySelector('.metric-item:nth-child(2) .metric-label').textContent = t.volume;
      // News Header Label Logic below
      document.querySelector('.risk-title').textContent = t.riskFactor;
      document.querySelector('.disclaimer-title').textContent = t.disclaimerTitle;
      document.querySelector('.disclaimer-text').textContent = t.disclaimerText;
      document.querySelector('.header-label').textContent = t.stockTicker;
      document.querySelector('.price-label').textContent = t.priceLabel;
      document.querySelector('.brand-label').textContent = t.sendByKairAlert;

      $('uid').textContent = uid;

      // News Tag Logic
      const tagEl = $('newsTag');
      const code = data.category_code;
      let hasTag = false;

      if (code && TAG_COLOR_MAP[code]) {
        const map = currentLang === 'zh' ? TAG_MAP_ZH : TAG_MAP_EN;
        const text = map[code];
        const colorNum = TAG_COLOR_MAP[code];

        if (text) {
          hasTag = true;
          tagEl.className = 'news-tag';
          tagEl.textContent = text;
          const solidColor = numberToHexStr(colorNum);
          const bgColor = hexToRgba(colorNum, 0.25); // Low opacity bg

          tagEl.style.color = solidColor;
          tagEl.style.backgroundColor = bgColor;
          tagEl.style.border = `1px solid ${hexToRgba(colorNum, 0.4)}`;
        }
      }

      if (!hasTag) {
        tagEl.className = 'section-label';
        tagEl.textContent = t.latestInsight;
        tagEl.style = ''; // Clear styles
      }

      // Button Text
      document.querySelector('#js-btn-detail .btn-text').textContent = t.btnDetail;
      document.querySelector('#js-btn-trade .btn-text').textContent = t.btnTrade;

      $('toast').textContent = t.copied;

      $('tickerText').textContent = data.ticker;

      // Set Logo (TradingView)
      const logoEl = $('tickerLogo');
      if (data.logoid) {
        logoEl.src = `https://s3-symbol-logo.tradingview.com/${data.logoid}.svg`;
        logoEl.onload = () => logoEl.classList.add('loaded');
        logoEl.onerror = () => logoEl.classList.remove('loaded');
      } else {
        logoEl.classList.remove('loaded');
      }

      $('marketCap').textContent = data.market_cap;
      $('volume').textContent = data.volume;
      $('newsTitle').textContent = data.title;
      $('analysis').textContent = data.analysis;

      // Conditional Risk Warning
      if (!data.risk || data.risk.trim() === '') {
        document.querySelector('.risk-box').style.display = 'none';
      } else {
        document.querySelector('.risk-box').style.display = 'flex';
        $('risk').textContent = data.risk; // Pure text
      }
      $('newsTimestamp').textContent = new Date(1 * data.timestamp).toLocaleString();

      const changeEl = $('priceChange');
      const priceEl = $('price');
      // Remove % if present to avoid double %%
      const changeVal = data.change.replace('%', '');
      const upDownCls = changeVal * 1 > 0 ? 'text-up' : changeVal * 1 == 0 ? '' : 'text-down';

      priceEl.textContent = '$' + data.price;
      changeEl.textContent = changeVal + '%';

      priceEl.className = 'price ' + upDownCls;
      changeEl.className = 'price-change ' + upDownCls;

      $('version').textContent = "Version: " + VERSION;

      updateBrokerButtons(data);

      loadingEl.classList.add('hidden');
      cardEl.classList.remove('hidden');

      // Init chart after container is visible to get correct dimensions
      initChart(data);
    }

    function copyTicker() {
      const tickerText = $('tickerText').textContent;
      navigator.clipboard.writeText(tickerText).then(() => {
        showToast(translations[currentLang].copied);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    }

    // Broker Configuration
    const BROKERS = [
      {
        id: 'tradingview',
        name: 'TradingView',
        logo: 'https://static.tradingview.com/static/images/favicon.ico',
        supports: ['web'],
        url: {
          web: ['https://www.tradingview.com/symbols/${exchange}-${ticker}/']
        }
      },
      {
        id: 'ibkr',
        name: 'IBKR',
        logo: 'https://www.interactivebrokers.com/campus/wp-content/themes/campus-theme/fav-icons/campus/favicon.png',
        supports: ['web'],
        url: {
          web: ['https://www.interactivebrokers.com/portal/#/quote/${ibkr_conid}']
        }
      },
      {
        id: 'webull',
        name: 'WeBull',
        logo: 'https://www.webull.com/favicon.ico',
        supports: ['web'],
        url: {
          web: ['https://www.webullapp.com/ticker/${exchange}-${ticker}']
        }
      },
      {
        id: 'bbae',
        name: 'BBAE',
        logo: 'https://www.bbae.com/wp-content/uploads/favicon-512px-300x300.webp',
        supports: ['app'],
        url: {
          app: ['bbae://stock?symbol=${ticker}']
        }
      },
      {
        id: 'futu',
        name: 'Futu',
        logo: 'https://www.futunn.com/favicon.ico',
        supports: ['app'],
        url: {
          web: ['https://www.futunn.com/stock/${ticker}-US'],
          app: ['ftnn://quote/stockDetail/${futu_id}/1', 'futunn://trade/US/${ticker}/10/0']
        }
      },
      {
        id: 'tiger',
        name: 'Tiger',
        logo: 'https://c1.itigergrowtha.com/portal5/static/media/logo.76.ba630aec.png',
        supports: ['app'],
        url: {
          web: ['https://www.itiger.com/stock/${ticker}'],
          app: ['tigerbrokersusstock://com.tigerbrokers.usstock/main/J/stock?symbol=${ticker}&market=US&secType=STK', 'tigerbrokersusstock://com.tigerbrokers.usstock/main/J/place_order?symbol=${ticker}&market=US&secType=STK&action=BUY']
        }
      },
      {
        id: 'longbridge',
        name: 'Longbridge',
        logo: 'https://play-lh.googleusercontent.com/vpzamIWbs4g3C2h5mSnQlDaPY2ZeelYI5KdPkar7rOMKSSmqkqM8FIYYzQFaqpZ2LsU-',
        supports: ['app'],
        url: {
          app: ['lb://page/stock/detail?id=ST/US/${ticker}', 'lb://page/trade/order?counter_id=ST/US/${ticker}']
        }
      },
      {
        id: 'firsttrade',
        name: 'FirstTrade',
        logo: 'https://invest.firstrade.com/app/favicon.ico',
        supports: ['web'],
        url: {
          web: ['https://invest.firstrade.com/app/stocks-etf/${ticker}/overview']
        }
      }
    ];

    const ICONS = {
      web: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`,
      app: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>`,
      check: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`
    };

    // Settings Modal Logic
    function openSettingsModal() {
      renderBrokers();
      $('settingsModal').classList.add('show');
      const title = currentLang === 'zh' ? '选择券商' : 'Select Broker';
      document.querySelector('.modal-title').textContent = title;
    }

    function closeSettingsModal() {
      updateBrokerButtons(queryData);
      $('settingsModal').classList.remove('show');
    }

    function selectBroker(brokerId) {
      localStorage.setItem('broker_id', brokerId);

      // Update UI directly without re-rendering
      const items = document.querySelectorAll('.broker-item');
      items.forEach(item => {
        if (item.dataset.id === brokerId) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function renderBrokers() {
      const listEl = $('brokerList');
      listEl.innerHTML = '';
      const selectedId = localStorage.getItem('broker_id');

      BROKERS.forEach(broker => {
        const isSelected = broker.id === selectedId;
        const item = document.createElement('div');
        item.className = `broker-item ${isSelected ? 'selected' : ''}`;
        item.dataset.id = broker.id; // Assign ID for efficient selection
        item.onclick = () => selectBroker(broker.id);

        let supportsHtml = '';
        if (broker.supports.includes('web')) {
          supportsHtml += `<div class="platform-icon">${ICONS.web} Web</div>`;
        }
        if (broker.supports.includes('app')) {
          supportsHtml += `<div class="platform-icon">${ICONS.app} App</div>`;
        }

        item.innerHTML = `
          <div class="broker-info">
              <img src="${broker.logo}" class="broker-logo" alt="${broker.name}">
              <div>
                  <div class="broker-name">${broker.name}</div>
                  <div class="broker-meta">
                      ${supportsHtml}
                  </div>
              </div>
          </div>
          <div class="check-icon">
              ${ICONS.check}
          </div>
        `;
        listEl.appendChild(item);
      });
    }

    // Close modal on click outside
    document.getElementById('settingsModal').addEventListener('click', (e) => {
      if (e.target.id === 'settingsModal') {
        closeSettingsModal();
      }
    });

    function showToast(message) {
      const toast = $('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 2000);
    }

    // Mock Data Generator
    function generateMockChartData(basePrice, totalMinutes = 390) {
      const data = [];
      let currentPrice = parseFloat(basePrice);
      const volatility = currentPrice * 0.002; // 0.2% volatility

      for (let i = 0; i < totalMinutes; i++) {
        const change = (Math.random() - 0.5) * volatility;
        currentPrice += change;
        // ensure positive
        if (currentPrice < 0.01) currentPrice = 0.01;
        data.push(currentPrice);
      }
      return data;
    }

    // Data Decompression
    function decompressChartData(compressed) {
      if (!compressed) return [];
      const [baseStr, diffsStr] = compressed.split('|');
      if (!baseStr || !diffsStr) return [];

      let currentPrice = parseFloat(baseStr);
      const prices = [currentPrice];
      const diffs = diffsStr.split(',');

      diffs.forEach(d => {
        if (d.startsWith('_')) {
          // Gaps: "_" or "_5"
          let count = 1;
          if (d.length > 1) {
            count = parseInt(d.substring(1), 10);
            if (isNaN(count)) count = 1;
          }
          for (let k = 0; k < count; k++) {
            prices.push(null);
          }
        } else {
          const delta = parseInt(d, 10) / 100;
          if (!isNaN(delta)) {
            currentPrice += delta;
            prices.push(currentPrice);
          } else {
            prices.push(null);
          }
        }
      });
      return prices;
    }

    // Canvas Drawing Logic
    function drawChart(canvas, prices, pushIndex) {
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);

      const width = rect.width;
      const height = rect.height;

      // Theme colors
      const colorLine = '#2dd4bf'; // accent-teal
      const colorBgStart = 'rgba(45, 212, 191, 0.2)';
      const colorBgEnd = 'rgba(45, 212, 191, 0)';
      const colorText = '#a0a0a0';
      const colorMarker = '#fb7185'; // market-up (red/pink) for accent or white

      ctx.clearRect(0, 0, width, height);

      if (!prices || prices.length === 0) return;

      // Calculate Range (Ignore nulls)
      const validPrices = prices.filter(p => p !== null);
      if (validPrices.length === 0) return;

      const minPrice = Math.min(...validPrices);
      const maxPrice = Math.max(...validPrices);
      const range = maxPrice - minPrice;
      const padding = range * 0.1 || 0.01; // Avoid 0 range
      const effectiveMin = minPrice - padding;
      const effectiveMax = maxPrice + padding;
      const effectiveRange = effectiveMax - effectiveMin;

      // Dynamic Edge Padding
      // Only apply padding if the push marker is at the very beginning or end
      const edgeThreshold = 14;
      let paddingLeft = 0;
      let paddingRight = 0;

      if (typeof pushIndex === 'number') {
        if (pushIndex === 0) {
          paddingLeft = edgeThreshold;
        } else if (pushIndex >= prices.length - 1) {
          paddingRight = edgeThreshold;
        }
      }

      const effectiveWidth = width - paddingLeft - paddingRight;

      // Vertical Padding for Header (Title)
      // Reserve space at the top so lines don't overlap with text
      // Vertical Padding for Header (Title)
      // Reserve space at the top so lines don't overlap with text
      const topPadding = 55;
      const graphHeight = height - topPadding;

      // Helper: Map x, y
      const getX = (i) => paddingLeft + (i / (prices.length - 1)) * effectiveWidth;
      const getY = (p) => height - ((p - effectiveMin) / effectiveRange) * graphHeight;

      // Draw Area (Gradient) - Handle Gaps (Fill separate segments)
      const gradient = ctx.createLinearGradient(0, 0, 0, height);
      gradient.addColorStop(0, colorBgStart);
      gradient.addColorStop(1, colorBgEnd);
      ctx.fillStyle = gradient;

      // Find segments
      let segmentStart = -1;

      const fillSegment = (start, end) => {
        ctx.beginPath();
        ctx.moveTo(getX(start), height);
        for (let i = start; i <= end; i++) {
          ctx.lineTo(getX(i), getY(prices[i]));
        }
        ctx.lineTo(getX(end), height);
        ctx.closePath();
        ctx.fill();
      };

      for (let i = 0; i < prices.length; i++) {
        if (prices[i] !== null) {
          if (segmentStart === -1) segmentStart = i;
        } else {
          if (segmentStart !== -1) {
            fillSegment(segmentStart, i - 1);
            segmentStart = -1;
          }
        }
      }
      if (segmentStart !== -1) fillSegment(segmentStart, prices.length - 1);


      // Draw Line - Handle Gaps
      ctx.beginPath();
      ctx.strokeStyle = colorLine;
      ctx.lineWidth = 2;
      ctx.lineJoin = 'round';

      let movedTo = false;
      for (let i = 0; i < prices.length; i++) {
        if (prices[i] === null) {
          movedTo = false;
          continue;
        }
        if (!movedTo) {
          ctx.moveTo(getX(i), getY(prices[i]));
          movedTo = true;
        } else {
          ctx.lineTo(getX(i), getY(prices[i]));
        }
      }
      ctx.stroke();

      // Watermark Logic ('search_web' placeholder - logic replaced by restricted version below)
      // (The rest of watermark logic follows separately, ensuring we only replace up to Line logic)

      const logoUrl = 'https://kairalert.pro/assets/logo.png';
      const logoImg = new Image();
      logoImg.src = logoUrl;

      // Draw watermark once image is loaded (or if cached)
      // Draw watermark once image is loaded (or if cached)
      // Draw watermark once image is loaded (or if cached)
      const drawWatermark = () => {
        const logoWidth = 60; // Target width
        const ratio = logoImg.width / logoImg.height;
        const logoHeight = logoWidth / ratio;

        // Dynamic Positioning Logic (Restricted)
        const padding = 10;
        // Only consider Bottom Left and Bottom Right
        const candidates = [
          // Bottom Left (Priority 1)
          { x: padding, y: height - logoHeight - padding, score: 0 },
          // Bottom Right (Priority 2)
          { x: width - logoWidth - padding, y: height - logoHeight - padding, score: 0 }
        ];

        // Evaluate only these two positions
        candidates.forEach(pos => {
          let collisionCount = 0;
          const startX = pos.x;
          const endX = pos.x + logoWidth;
          const startI = Math.floor(startX * (prices.length - 1) / width);
          const endI = Math.ceil(endX * (prices.length - 1) / width);

          for (let i = startI; i <= endI; i++) {
            if (i < 0 || i >= prices.length) continue;
            const priceY = getY(prices[i]);
            if (priceY >= pos.y - 5 && priceY <= pos.y + logoHeight + 5) {
              collisionCount++;
            }
          }
          pos.score = collisionCount;
        });

        // Logic: Pick lowest score. If both > 0 (collision), fallback to Bottom Left (index 0).
        // If index 1 (BR) is clean (score 0) and BL is dirty (>0), pick BR.
        // Otherwise (both clean or both dirty), default to BL (Priority 1).
        let bestPos = candidates[0]; // Default BL
        if (candidates[1].score === 0 && candidates[0].score > 0) {
          bestPos = candidates[1]; // Switch to BR if clean and BL is dirty
        }

        ctx.save();
        ctx.globalAlpha = 0.4; // Low opacity
        ctx.drawImage(logoImg, bestPos.x, bestPos.y, logoWidth, logoHeight);
        ctx.restore();

        // 4. Draw Info Text (Top Left)
        // Symbol + Date
        ctx.save();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; // Low contrast text
        ctx.font = 'bold 12px sans-serif';
        const tickerStr = (window.queryData && window.queryData.ticker) ? window.queryData.ticker.toUpperCase() : (queryData.ticker || 'UNKNOWN').toUpperCase();

        // Format Date: e.g. "2024-01-15 (Post-market)"
        let dateStr = '--';
        const ts = (window.queryData && window.queryData.timestamp) ? window.queryData.timestamp : queryData.timestamp;

        if (ts) {
          const d = new Date(parseInt(ts));

          // Market Session Logic (US ET)
          // Simplified: Convert to ET string, parse hour/minute
          let session = '';
          try {
            // Use Intl to get NY time parts
            const options = { timeZone: "America/New_York", hour12: false, hour: 'numeric', minute: 'numeric' };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(d);
            const h = parseInt(parts.find(p => p.type === 'hour').value);
            const m = parseInt(parts.find(p => p.type === 'minute').value);
            const timeVal = h * 60 + m; // Minutes from 00:00

            // 09:30 = 570 mins
            // 16:00 = 960 mins
            if (timeVal < 570) session = 'Pre-market';
            else if (timeVal >= 960) session = 'Post-market';
            else session = 'Market';
          } catch (e) {
            session = 'Market'; // Fallback
          }

          const year = d.getFullYear();
          const month = (d.getMonth() + 1).toString().padStart(2, '0');
          const day = d.getDate().toString().padStart(2, '0');
          dateStr = `${year}-${month}-${day} · ${session}`;
        }

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // Title at ~15px from top
        ctx.fillText(tickerStr + ' · ' + dateStr, width / 2, 18);
        ctx.restore();
      };

      if (logoImg.complete) {
        drawWatermark();
      } else {
        logoImg.onload = drawWatermark;
      }

      // Draw Push Marker
      if (pushIndex >= 0 && pushIndex < prices.length) {
        const markerX = getX(pushIndex);
        const markerY = getY(prices[pushIndex]);

        // 3. Icon Badge (Bell) - Calculated First for Line Start
        const badgeSize = 20;
        // Position Badge safely BELOW the Title Area (Y ~ 40)
        // Title is at Y=18 (Text height ~12px). 
        // Badge size 20. Top of Badge = 30.
        const badgeY = 40;

        // 1. Vertical Gradient Line (Fade out)
        // Start line from BOTTOM of Badge to ensure no overlap
        const lineStartY = badgeY + badgeSize / 2;

        const lineGrad = ctx.createLinearGradient(0, 0, 0, height);
        lineGrad.addColorStop(0, hexToRgba(TAG_COLOR_MAP['C1'] || 0xfb7185, 0.8)); // Top solid
        lineGrad.addColorStop(1, hexToRgba(TAG_COLOR_MAP['C1'] || 0xfb7185, 0));   // Bottom transparent

        ctx.beginPath();
        ctx.moveTo(markerX, lineStartY);
        ctx.lineTo(markerX, height);
        ctx.strokeStyle = lineGrad;
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // 2. Pulse Point (Glowing Effect)
        // Outer Glow
        ctx.beginPath();
        ctx.arc(markerX, markerY, 8, 0, Math.PI * 2);
        ctx.fillStyle = hexToRgba(TAG_COLOR_MAP['C1'] || 0xfb7185, 0.3);
        ctx.fill();

        // Inner Dot
        ctx.beginPath();
        ctx.arc(markerX, markerY, 4, 0, Math.PI * 2);
        ctx.fillStyle = '#fff';
        ctx.fill();
        ctx.strokeStyle = colorMarker;
        ctx.lineWidth = 2;
        ctx.stroke();

        // Badge Background (Pill shape)
        ctx.beginPath();
        ctx.roundRect(markerX - badgeSize / 2, badgeY - badgeSize / 2, badgeSize, badgeSize, 6);
        ctx.fillStyle = colorMarker;
        ctx.shadowColor = 'rgba(0,0,0,0.3)';
        ctx.shadowBlur = 4;
        ctx.fill();
        ctx.shadowBlur = 0; // Reset shadow

        // Bell Icon (Fixed Proportions)
        ctx.fillStyle = '#fff';
        const bx = markerX;
        const by = badgeY;
        ctx.beginPath();

        // Draw standard bell shape
        // Center x=bx, y=by. Size approx 10x10.
        // Top part
        ctx.moveTo(bx, by - 4);
        ctx.quadraticCurveTo(bx + 3, by - 4, bx + 3, by + 1); // Curve down right
        ctx.lineTo(bx + 4.5, by + 3);  // Flare right
        ctx.lineTo(bx - 4.5, by + 3);  // Bottom line across
        ctx.lineTo(bx - 3, by + 1);    // Flare left
        ctx.quadraticCurveTo(bx - 3, by - 4, bx, by - 4); // Curve up left
        ctx.fill();

        // Clapper
        ctx.beginPath();
        ctx.arc(bx, by + 4, 1.2, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initChart(data) {
      const canvas = $('stockChart');
      if (!canvas) return;

      // Mock Logic: 
      // 1. Generate ~240 points (4 hours * 60)
      // 2. Determine "Push Index" based on current time or just pick a random spot (e.g., 75% through)
      // Since we don't have historical data API, we simulate "Push Time" relative to "Now" in the chart context.

      // Use data.price as base
      const basePrice = data.price ? parseFloat(data.price) : 100;

      // --- REAL DATA INTEGRATION EXAMPLE (真实数据接入示例) ---
      /*
      // Replace generateMockChartData with your API call:
      // 1. Fetch minute-level data (e.g., from your backend or a provider like Alpaca/Polygon/Yahoo)
      //    const response = await fetch(\`/api/stock/history?symbol=\${data.ticker}&interval=1m\`);
      //    const history = await response.json(); 
      //    // Expected format: array of price objects { timestamp: 1234567890, close: 150.2 }
      
      // 2. Map the data to a simple price array for the chart
      //    const points = history.map(item => item.close);
      
      // 3. Find the index corresponding to the Push Timestamp
      //    const pushTime = parseInt(data.timestamp); // Timestamp from the URL
      //    let pushIndex = -1;
      //    // Find closest candle index
      //    points.forEach((p, index) => {
      //       const candleTime = history[index].timestamp;
      //       if (Math.abs(candleTime - pushTime) < 60 * 1000) { // Within 1 minute
      //           pushIndex = index;
      //       }
      //    });
      
      // 4. Draw Chart
      //    drawChart(canvas, points, pushIndex);
      */

      /*
      // TEST COMPRESSION WITH GAPS
      // ...
      */

      let points = [];
      let pushIndex = 0;

      if (data.compressed_chart) {
        // Use Real Data
        points = decompressChartData(data.compressed_chart);

        // Calculate Push Index
        // If we have real data, we assume the data ends "now" or strictly covers the day.
        // The push timestamp is data.timestamp.
        // BUT: The compressed strings don't have timestamps. 
        // We usually assume minute-level interval.
        // Simplification for Static Card:
        // If we provide the chart, we should ideally know where the push is.
        // Maybe we just assume the push is the LAST point? Or calculate time?
        // Let's assume the chart covers the US trading day (390 mins).
        // For now, let's place it at the *same relative time* as the timestamp? 
        // Better: Just defaults to the end or 80% if not calculable. 
        // Or - add pushIndex to q param? No, too complex.
        // Let's rely on time if possible. 
        // For this specific request "Reduce code size", we just want to load the points.
        // We will default pushIndex to "last point" - 15 mins (recent) or just verify visually.
        pushIndex = points.length - 1; // Default to latest
      } else {
        // Fallback to Mock
        const basePrice = data.price ? parseFloat(data.price) : 100;
        points = generateMockChartData(basePrice, 390);
        pushIndex = Math.floor(points.length * 0.8);
      }

      // Initial Draw
      drawChart(canvas, points, pushIndex);

      // Handle Resize
      window.addEventListener('resize', () => {
        drawChart(canvas, points, pushIndex);
      });
    }

    initUid();

    document.addEventListener('DOMContentLoaded', render);
  </script>
</body>

</html>