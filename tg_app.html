<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KairAlert App</title>
  <style>
    html, body {
      padding: 0;
      margin: 15px;
      background-color: black;
      color: white;
      font-size: 14px;
    }

    p {
      margin: 0;
      padding: 0;
    }

    .header {
      display: flex;
      flex-direction: row;
      align-items: center;
      margin-bottom: 15px;
    }

    .header img {
      width: 50px;
      height: 50px;
      margin-right: 15px;
      border-radius: 50%;
    }

    .title {
      font-weight: 700;
      font-size: 16px;
    }

    .time {
      font-size: 14px;
      color: #4a4a4a;
    }

    .item {
      margin-bottom: 8px;
    }

    .item strong {
      font-weight: 700;
      color: white;
    }

    .highlight {
      font-size: 14px;
      font-weight: 700;
      color: #028f7e;
    }

    .tips {
      font-size: 14px;
      font-weight: bold;
      color: #b50101;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="/assets/kairalert_english.png" />
      <div class="info">
        <p class="title" id="ticker"></p>
        <p class="time" id="time"></p>
      </div>
    </div>
    <p class="item" id="marketCap"></p>
    <p class="item" id="volume"></p>
    <p class="item" id="price"></p>
    <p class="item highlight" id="title"></p>
    <p class="item" id="analysis"></p>
    <p class="item" id="risk"></p>
    <p class="tips">内容仅供参考，不作为投资依据。</p>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    // let params = new URLSearchParams(window.location.search);
    // document.getElementById("ticker").innerText = params.get("ticker");
    // document.getElementById("price").innerText = params.get("price");

    const webApp = window.Telegram.WebApp;

    webApp.ready(); // 通知 Telegram 小程序已准备好
    webApp.expand(); // 建议自动全屏展开

    // 获取参数
    const safePayload = webApp.initDataUnsafe.start_param;

    if (safePayload) {
        try {
            // --- 这里是之前的解码逻辑 ---

            // 1. 还原字符 (- 转 +, _ 转 /)
            let base64Str = safePayload.replace(/-/g, '+').replace(/_/g, '/');

            // 2. 补全 Padding (=)
            const pad = base64Str.length % 4;
            if (pad) {
                base64Str += '='.repeat(4 - pad);
            }

            // 3. UTF-8 解码 (完美支持中文)
            const binaryString = atob(base64Str);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const decodedString = new TextDecoder('utf-8').decode(bytes);

            // 4. 拆分数据 (按照 ||| 拆分)
            // 顺序: [0]代码, [1]市值, [2]成交量, [3]价格, [4]标题, [5]逻辑, [6]风险
            const parts = decodedString.split('|||');

            // --- 渲染到页面 ---
            document.getElementById('ticker').innerHTML = '<strong>股票代码:</strong> ' + parts[0];
            document.getElementById('marketCap').innerHTML = '<strong>公司市值:</strong> ' + parts[1];
            document.getElementById('volume').innerHTML = '<strong>盘中成交:</strong> ' + parts[2];
            document.getElementById('price').innerHTML = '<strong>当前价格:</strong> ' + parts[3];
            document.getElementById('title').innerHTML = '<strong>新闻标题:</strong> ' + parts[4];
            document.getElementById('analysis').innerHTML = '<strong>初步分析:</strong> ' + parts[5];
            document.getElementById('risk').innerHTML = '<strong>风险提示:</strong> ' + parts[6];

            document.getElementById('time').innerText = '更新时间: ' + new Date().toLocaleString();

        } catch (e) {
            document.getElementById('title').innerText = "数据解析错误";
            console.error(e);
        }
    } else {
        document.getElementById('title').innerText = "未检测到参数";
    }
  </script>
</body>
</html>